{"ast":null,"code":"import _regeneratorRuntime from\"/Users/duyennguyen/STREAMING/amazon-ivs-virtual-qa-web-demo/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _slicedToArray from\"/Users/duyennguyen/STREAMING/amazon-ivs-virtual-qa-web-demo/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _asyncToGenerator from\"/Users/duyennguyen/STREAMING/amazon-ivs-virtual-qa-web-demo/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import React from'react';import SignInModal from'./SignInModal';import UserContext from'../providers/UserContext';import IVSContext from'../providers/IVSContext';import VoteContext from'../providers/VoteContext';import{SET_SIGNED_IN_USER_ACTION,SET_SIGNED_OUT_USER_ACTION}from'../providers/UserProvider';import{SET_VOTES_ACTION,CLEAR_VOTES_ACTION}from'../providers/VoteProvider';import{Hub,Auth}from'aws-amplify';import{HTTP_API_ENDPOINT}from'../config';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var GET_VOTES_ENDPOINT=HTTP_API_ENDPOINT+'/getVotes';function fetchSetUserInfoVotes(_x,_x2,_x3,_x4){return _fetchSetUserInfoVotes.apply(this,arguments);}function _fetchSetUserInfoVotes(){_fetchSetUserInfoVotes=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(userDispatch,voteDispatch,signInUserSession,channelArn){var votesResponse,votes,questionIdMap;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:userDispatch({type:SET_SIGNED_IN_USER_ACTION,isModerator:getModeratorStatusFromSession(signInUserSession),accessJWTToken:signInUserSession.accessToken.jwtToken});_context2.next=3;return fetch(GET_VOTES_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json','Authorization':signInUserSession.accessToken.jwtToken},body:JSON.stringify({channelArn:channelArn})});case 3:votesResponse=_context2.sent;if(!(votesResponse.status===200)){_context2.next=10;break;}_context2.next=7;return votesResponse.json();case 7:votes=_context2.sent;questionIdMap=votes.reduce(function(map,v){map[v.QuestionId]=true;return map;},{});voteDispatch({type:SET_VOTES_ACTION,questionIdMap:questionIdMap});case 10:case\"end\":return _context2.stop();}}},_callee2);}));return _fetchSetUserInfoVotes.apply(this,arguments);}function getModeratorStatusFromSession(session){var userGroups=session.idToken.payload['cognito:groups'];if(userGroups!==undefined&&userGroups.indexOf('moderator')!==-1){return true;}else{return false;}}function SignInButton(){var _React$useState=React.useState(false),_React$useState2=_slicedToArray(_React$useState,2),modalVisible=_React$useState2[0],setModalVisibility=_React$useState2[1];var _React$useContext=React.useContext(UserContext),_React$useContext2=_slicedToArray(_React$useContext,2),isSignedIn=_React$useContext2[0].isSignedIn,userDispatch=_React$useContext2[1];var _React$useContext3=React.useContext(IVSContext),channelArn=_React$useContext3.channelArn;var _React$useContext4=React.useContext(VoteContext),_React$useContext5=_slicedToArray(_React$useContext4,2),voteDispatch=_React$useContext5[1];var showModal=function showModal(){return setModalVisibility(true);};var hideModal=function hideModal(){return setModalVisibility(false);};var handleClick=function handleClick(){if(isSignedIn){Auth.signOut();}else{showModal();}};React.useEffect(function(){function setAuthListeners(){return _setAuthListeners.apply(this,arguments);}function _setAuthListeners(){_setAuthListeners=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var user;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:Hub.listen('auth',function(_ref){var payload=_ref.payload;switch(payload.event){case'signIn':fetchSetUserInfoVotes(userDispatch,voteDispatch,payload.data.signInUserSession,channelArn);break;default:// case: 'signOut'\nuserDispatch({type:SET_SIGNED_OUT_USER_ACTION});voteDispatch({type:CLEAR_VOTES_ACTION});break;}});_context.prev=1;_context.next=4;return Auth.currentAuthenticatedUser();case 4:user=_context.sent;fetchSetUserInfoVotes(userDispatch,voteDispatch,user.signInUserSession,channelArn);_context.next=12;break;case 8:_context.prev=8;_context.t0=_context[\"catch\"](1);userDispatch({type:SET_SIGNED_OUT_USER_ACTION});voteDispatch({type:CLEAR_VOTES_ACTION});case 12:case\"end\":return _context.stop();}}},_callee,null,[[1,8]]);}));return _setAuthListeners.apply(this,arguments);}setAuthListeners();// eslint-disable-next-line\n},[]);return/*#__PURE__*/_jsxs(React.Fragment,{children:[modalVisible&&/*#__PURE__*/_jsx(SignInModal,{onHideModal:hideModal}),/*#__PURE__*/_jsx(\"button\",{className:isSignedIn?'btn':'btn btn--primary',onClick:handleClick,children:isSignedIn?'Sign out':'Sign in'})]});}export default SignInButton;","map":{"version":3,"sources":["/Users/duyennguyen/STREAMING/amazon-ivs-virtual-qa-web-demo/frontend/src/auth/SignInButton.js"],"names":["React","SignInModal","UserContext","IVSContext","VoteContext","SET_SIGNED_IN_USER_ACTION","SET_SIGNED_OUT_USER_ACTION","SET_VOTES_ACTION","CLEAR_VOTES_ACTION","Hub","Auth","HTTP_API_ENDPOINT","GET_VOTES_ENDPOINT","fetchSetUserInfoVotes","userDispatch","voteDispatch","signInUserSession","channelArn","type","isModerator","getModeratorStatusFromSession","accessJWTToken","accessToken","jwtToken","fetch","method","headers","body","JSON","stringify","votesResponse","status","json","votes","questionIdMap","reduce","map","v","QuestionId","session","userGroups","idToken","payload","undefined","indexOf","SignInButton","useState","modalVisible","setModalVisibility","useContext","isSignedIn","showModal","hideModal","handleClick","signOut","useEffect","setAuthListeners","listen","event","data","currentAuthenticatedUser","user"],"mappings":"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","sourcesContent":["import React from 'react';\nimport SignInModal from './SignInModal';\nimport UserContext from '../providers/UserContext';\nimport IVSContext from '../providers/IVSContext';\nimport VoteContext from '../providers/VoteContext';\nimport {\n    SET_SIGNED_IN_USER_ACTION,\n    SET_SIGNED_OUT_USER_ACTION,\n} from '../providers/UserProvider';\nimport {\n    SET_VOTES_ACTION,\n    CLEAR_VOTES_ACTION,\n} from '../providers/VoteProvider';\nimport { Hub, Auth } from 'aws-amplify'\nimport { HTTP_API_ENDPOINT } from '../config';\n\nconst GET_VOTES_ENDPOINT = HTTP_API_ENDPOINT + '/getVotes';\n\nasync function fetchSetUserInfoVotes(userDispatch, voteDispatch, signInUserSession, channelArn) {\n    userDispatch({\n        type: SET_SIGNED_IN_USER_ACTION,\n        isModerator: getModeratorStatusFromSession(signInUserSession),\n        accessJWTToken: signInUserSession.accessToken.jwtToken,\n    })\n\n    const votesResponse = await fetch(GET_VOTES_ENDPOINT, {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n            'Authorization': signInUserSession.accessToken.jwtToken,\n        },\n        body: JSON.stringify({ channelArn }),\n    });\n\n    if (votesResponse.status === 200) {\n        const votes = await votesResponse.json()\n        const questionIdMap = votes.reduce((map, v) => {\n            map[v.QuestionId] = true;\n            return map;\n        }, {})\n        voteDispatch({\n            type: SET_VOTES_ACTION,\n            questionIdMap,\n        })\n    }\n}\n\nfunction getModeratorStatusFromSession(session) {\n    const userGroups = session.idToken.payload['cognito:groups'];\n    if (userGroups !== undefined && userGroups.indexOf('moderator') !== -1) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\nfunction SignInButton() {\n    const [modalVisible, setModalVisibility] = React.useState(false);\n    const [{ isSignedIn }, userDispatch] = React.useContext(UserContext);\n    const { channelArn } = React.useContext(IVSContext);\n    const [, voteDispatch] = React.useContext(VoteContext)\n    const showModal = () => setModalVisibility(true)\n    const hideModal = () => setModalVisibility(false)\n    const handleClick = () => {\n        if (isSignedIn) {\n            Auth.signOut()\n        } else {\n            showModal()\n        }\n    }\n\n    React.useEffect(() => {\n        async function setAuthListeners() {\n            Hub.listen('auth', ({ payload }) => {\n                switch (payload.event) {\n                    case 'signIn':\n                        fetchSetUserInfoVotes(userDispatch, voteDispatch, payload.data.signInUserSession, channelArn);\n                    break;\n                    default: // case: 'signOut'\n                        userDispatch({ type: SET_SIGNED_OUT_USER_ACTION });\n                        voteDispatch({ type: CLEAR_VOTES_ACTION });\n                    break;\n                }\n            });\n            try {\n                const user = await Auth.currentAuthenticatedUser();\n                fetchSetUserInfoVotes(userDispatch, voteDispatch, user.signInUserSession, channelArn);\n            } catch(e) {\n                userDispatch({ type: SET_SIGNED_OUT_USER_ACTION });\n                voteDispatch({ type: CLEAR_VOTES_ACTION });\n            }\n        }\n        setAuthListeners();\n        // eslint-disable-next-line\n    }, [])\n\n    return (\n        <React.Fragment>\n            { modalVisible && <SignInModal onHideModal={hideModal}/> }\n            <button\n                className={isSignedIn ? 'btn' : 'btn btn--primary'}\n                onClick={handleClick}\n            >\n                {isSignedIn ? 'Sign out' : 'Sign in'}\n            </button>\n        </React.Fragment>\n    )\n}\n\nexport default SignInButton;\n"]},"metadata":{},"sourceType":"module"}